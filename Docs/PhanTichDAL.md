# TÀI LI?U PHÂN TÍCH CHI TI?T TH? M?C DAL
## D? án: Qu?n Lý C?a Hàng R??u

---

## M?C L?C
1. [T?ng quan ki?n trúc DAL](#1-t?ng-quan-ki?n-trúc-dal)
2. [DbConfig - C?u hình Database](#2-dbconfig---c?u-hình-database)
3. [AuthDal - Xác th?c ??ng nh?p](#3-authdal---xác-th?c-??ng-nh?p)
4. [TaiKhoanDal - Qu?n lý tài kho?n](#4-taikhoandal---qu?n-lý-tài-kho?n)
5. [VaiTroDal - Qu?n lý vai trò](#5-vaitrodal---qu?n-lý-vai-trò)
6. [NhanVienDal - Qu?n lý nhân viên](#6-nhanviendal---qu?n-lý-nhân-viên)
7. [KhachHangDal - Qu?n lý khách hàng](#7-khachhangdal---qu?n-lý-khách-hàng)
8. [DoUongDal - Qu?n lý ?? u?ng](#8-douongdal---qu?n-lý-??-u?ng)
9. [LoaiDoUongDal - Qu?n lý lo?i ?? u?ng](#9-loaidouongdal---qu?n-lý-lo?i-??-u?ng)
10. [KyGuiRuouDal - Qu?n lý ký g?i r??u](#10-kyguiruoudal---qu?n-lý-ký-g?i-r??u)
11. [HoaDonDal - Qu?n lý hóa ??n](#11-hoadondal---qu?n-lý-hóa-??n)
12. [BanHangDal - X? lý bán hàng](#12-banhangdal---x?-lý-bán-hàng)
13. [ReportDal - Báo cáo th?ng kê](#13-reportdal---báo-cáo-th?ng-kê)
14. [ViTriLuuTruDal - Qu?n lý v? trí l?u tr?](#14-vitriluutrudal---qu?n-lý-v?-trí-l?u-tr?)

---

## 1. T?NG QUAN KI?N TRÚC DAL

### 1.1. DAL là gì?
**DAL (Data Access Layer)** là t?ng truy c?p d? li?u, ?óng vai trò trung gian gi?a t?ng giao di?n (GUI) và c? s? d? li?u (Database).

### 1.2. S? ?? ki?n trúc 3 t?ng

```
???????????????????????????????????????????????????????????????
?                    T?NG GIAO DI?N (GUI)                     ?
?    FrmLogin, FrmMain, FrmNhanVien, FrmBanHang, ...         ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?                 T?NG TRUY C?P D? LI?U (DAL)                ?
?  DbConfig, AuthDal, NhanVienDal, DoUongDal, BanHangDal...  ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?                 T?NG D? LI?U (Database)                     ?
?           SQL Server - QuanLyCuaHangRuou                    ?
???????????????????????????????????????????????????????????????
```

### 1.3. Danh sách các file DAL

| STT | File | Ch?c n?ng |
|-----|------|-----------|
| 1 | DbConfig.cs | C?u hình k?t n?i database |
| 2 | AuthDal.cs | Xác th?c ??ng nh?p |
| 3 | TaiKhoanDal.cs | Qu?n lý tài kho?n |
| 4 | VaiTroDal.cs | Qu?n lý vai trò |
| 5 | NhanVienDal.cs | Qu?n lý nhân viên |
| 6 | KhachHangDal.cs | Qu?n lý khách hàng |
| 7 | DoUongDal.cs | Qu?n lý ?? u?ng |
| 8 | LoaiDoUongDal.cs | Qu?n lý lo?i ?? u?ng |
| 9 | KyGuiRuouDal.cs | Qu?n lý ký g?i r??u |
| 10 | HoaDonDal.cs | Qu?n lý hóa ??n |
| 11 | BanHangDal.cs | X? lý bán hàng |
| 12 | ReportDal.cs | Báo cáo th?ng kê |
| 13 | ViTriLuuTruDal.cs | Qu?n lý v? trí l?u tr? |

### 1.4. ??c ?i?m chung c?a các class DAL

- **Static class**: T?t c? ??u là `static class` ?? g?i tr?c ti?p mà không c?n t?o ??i t??ng
- **Using pattern**: S? d?ng `DbConfig.Use()` ?? t? ??ng qu?n lý k?t n?i
- **Transaction**: Các thao tác ph?c t?p s? d?ng transaction ?? ??m b?o tính toàn v?n
- **GridRow class**: M?i DAL có nested class ?? hi?n th? d? li?u lên DataGridView
- **CRUD pattern**: Tuân theo m?u Create, Read, Update, Delete

---

## 2. DBCONFIG - C?U HÌNH DATABASE

### 2.1. M?c ?ích
Cung c?p các ph??ng th?c ti?n ích ?? t?o và qu?n lý k?t n?i database.

### 2.2. Các ph??ng th?c

#### 2.2.1. Create()
```
M?c ?ích: T?o DbContext m?i v?i c?u hình t?i ?u
Thu?t toán:
  1. T?o instance Model1 (Entity Framework DbContext)
  2. T?t LazyLoadingEnabled (tránh N+1 query)
  3. T?t ProxyCreationEnabled (t?i ?u hi?u n?ng)
  4. Tr? v? DbContext
```

#### 2.2.2. Use<T>(Func<Model1, T> func)
```
M?c ?ích: Th?c thi truy v?n và tr? v? k?t qu?, t? ??ng dispose
Thu?t toán:
  1. T?o DbContext b?ng Create()
  2. Th?c thi func(db) ???c truy?n vào
  3. T? ??ng Dispose DbContext khi hoàn t?t
  4. Tr? v? k?t qu? ki?u T
```

**Ví d? s? d?ng:**
```csharp
var list = DbConfig.Use(db => db.NhanViens.ToList());
```

#### 2.2.3. Use(Action<Model1> action)
```
M?c ?ích: Th?c thi hành ??ng không tr? v? k?t qu?
Thu?t toán:
  1. T?o DbContext
  2. Th?c thi action(db)
  3. T? ??ng Dispose
```

#### 2.2.4. TestConnection()
```
M?c ?ích: Ki?m tra k?t n?i database
Thu?t toán:
  1. T?o DbContext
  2. M? k?t n?i: db.Database.Connection.Open()
  3. Ki?m tra database t?n t?i: db.Database.Exists()
  4. ??m s? b?n ghi trong các b?ng chính
  5. Tr? v? tuple (ok, message)
```

#### 2.2.5. GetInnerMsg(Exception ex)
```
M?c ?ích: L?y thông báo l?i g?c t? exception l?ng nhau
Thu?t toán:
  1. N?u ex == null, tr? v? "L?i không xác ??nh"
  2. L?p: while (ex.InnerException != null) ex = ex.InnerException
  3. Tr? v? ex.Message
```

---

## 3. AUTHDAL - XÁC TH?C ??NG NH?P

### 3.1. M?c ?ích
X? lý logic ??ng nh?p h? th?ng.

### 3.2. Ph??ng th?c Login()

```
Input: username (string), password (string)
Output: (bool ok, string role, string error)

Thu?t toán:
???????????????????????????????????????????
? 1. Validate input                        ?
?    - Trim username                       ?
?    - Ki?m tra username r?ng ? l?i       ?
?    - Ki?m tra password r?ng ? l?i       ?
???????????????????????????????????????????
? 2. Ki?m tra k?t n?i database            ?
?    - G?i DbConfig.TestConnection()      ?
?    - N?u l?i ? tr? v? l?i k?t n?i       ?
???????????????????????????????????????????
? 3. Tìm tài kho?n                        ?
?    - G?i TaiKhoanDal.GetByUsername()    ?
?    - N?u không tìm th?y ? l?i           ?
???????????????????????????????????????????
? 4. Ki?m tra tài kho?n                   ?
?    - Ki?m tra TrangThai = true          ?
?    - So sánh Password                   ?
?    - N?u sai ? tr? v? LoginFailed       ?
???????????????????????????????????????????
? 5. Tr? v? thành công                    ?
?    - ok = true                          ?
?    - role = MaVaiTro (ADMIN/QUAN_LY/...)?
???????????????????????????????????????????
```

---

## 4. TAIKHOANDAL - QU?N LÝ TÀI KHO?N

### 4.1. M?c ?ích
Qu?n lý b?ng TaiKhoan trong database.

### 4.2. Các ph??ng th?c

| Ph??ng th?c | Input | Output | Mô t? |
|-------------|-------|--------|-------|
| GetByUsername() | username | TaiKhoan | Tìm tài kho?n theo username |
| ExistsUsername() | username | bool | Ki?m tra username ?ã t?n t?i |
| Add() | TaiKhoan | void | Thêm tài kho?n m?i |
| Update() | TaiKhoan | void | C?p nh?t tài kho?n |
| GenerateMaTK() | (không có) | string | T? sinh mã TK: "TK" + timestamp |

### 4.3. Thu?t toán GenerateMaTK()
```
Output: "TK" + DateTime.Now.ToString("yyyyMMddHHmmss")
Ví d?: "TK20251228143522"
```

---

## 5. VAITRODAL - QU?N LÝ VAI TRÒ

### 5.1. M?c ?ích
Qu?n lý b?ng VaiTro (phân quy?n).

### 5.2. Các ph??ng th?c

| Ph??ng th?c | Mô t? |
|-------------|-------|
| GetAll() | L?y danh sách t?t c? vai trò, s?p x?p theo TenVaiTro |
| GetById() | L?y vai trò theo MaVaiTro |

### 5.3. Các vai trò trong h? th?ng

| Mã vai trò | Tên | Quy?n h?n |
|------------|-----|-----------|
| ADMIN | Qu?n tr? viên | Toàn quy?n |
| QUAN_LY | Qu?n lý | Qu?n lý danh m?c, xóa NV th??ng |
| NHAN_VIEN | Nhân viên | Ch? xem và bán hàng |

---

## 6. NHANVIENDAL - QU?N LÝ NHÂN VIÊN

### 6.1. M?c ?ích
Qu?n lý b?ng NhanVien v?i ??y ?? CRUD và phân quy?n.

### 6.2. Class l?ng NhanVienGridRow
```
M?c ?ích: Ch?a d? li?u hi?n th? lên DataGridView
Properties:
  - MaNV, TenNV, SoDienThoai, DiaChi
  - Username, Role, MaVaiTro (t? TaiKhoan liên k?t)
  - TrangThai, HinhPath, MaTK
```

### 6.3. Các ph??ng th?c

#### 6.3.1. GetAllForGrid()
```
Thu?t toán:
  1. Truy v?n b?ng NhanViens
  2. Select ra NhanVienGridRow v?i:
     - Thông tin NhanVien
     - Username t? TaiKhoan liên k?t
     - Role t? VaiTro liên k?t
  3. Tr? v? List<NhanVienGridRow>
```

#### 6.3.2. SearchForGrid(string kw)
```
Thu?t toán:
  1. Trim keyword
  2. T?o query: db.NhanViens.AsQueryable()
  3. N?u kw không r?ng:
     Where: MaNV.Contains(kw) OR TenNV.Contains(kw) 
            OR SoDienThoai.Contains(kw) OR DiaChi.Contains(kw)
            OR Username.Contains(kw)
  4. Select ra NhanVienGridRow
  5. Tr? v? List
```

#### 6.3.3. AddWithAccount(NhanVien nv, TaiKhoan tk)
```
Thu?t toán (có Transaction):
???????????????????????????????????????????
? 1. Validate input                        ?
?    - nv, tk không null                  ?
?    - MaNV, TenNV không r?ng             ?
???????????????????????????????????????????
? 2. Ki?m tra quy?n t?o Admin             ?
?    - N?u không ph?i Admin và mu?n t?o  ?
?      Admin/Manager ? throw l?i          ?
???????????????????????????????????????????
? 3. B?t ??u Transaction                   ?
?    db.Database.BeginTransaction()       ?
???????????????????????????????????????????
? 4. Thêm TaiKhoan                        ?
?    db.TaiKhoans.Add(tk)                 ?
???????????????????????????????????????????
? 5. Liên k?t và thêm NhanVien            ?
?    nv.MaTK = tk.MaTK                    ?
?    db.NhanViens.Add(nv)                 ?
???????????????????????????????????????????
? 6. SaveChanges + Commit                  ?
?    N?u l?i ? Rollback                   ?
???????????????????????????????????????????
```

#### 6.3.4. Delete(string id)
```
Thu?t toán ph?c t?p (có Transaction và phân quy?n):
???????????????????????????????????????????
? 1. Validate id không r?ng               ?
???????????????????????????????????????????
? 2. Tìm nhân viên + TaiKhoan liên k?t    ?
???????????????????????????????????????????
? 3. Ki?m tra quy?n xóa                   ?
?    - Không ???c xóa chính mình          ?
?    - Không ???c xóa admin g?c           ?
?    - Manager ch? xóa ???c NHAN_VIEN     ?
???????????????????????????????????????????
? 4. Ki?m tra ràng bu?c                   ?
?    hasHD = có hóa ??n liên quan?        ?
???????????????????????????????????????????
? 5. X? lý xóa                            ?
?    NHÁNH A: Có hóa ??n ? Soft Delete    ?
?      - TrangThai = "?ã ngh?"            ?
?      - TaiKhoan.TrangThai = false       ?
?    NHÁNH B: Không có ? Hard Delete      ?
?      - Set null cho HoaDon.MaNV         ?
?      - Remove NhanVien                  ?
?      - Remove TaiKhoan                  ?
???????????????????????????????????????????
? 6. SaveChanges + Commit/Rollback        ?
???????????????????????????????????????????
```

---

## 7. KHACHHANGDAL - QU?N LÝ KHÁCH HÀNG

### 7.1. M?c ?ích
Qu?n lý b?ng KhachHang.

### 7.2. Class l?ng KhachHangGridRow
```
Properties: MaKH, TenKH, SoDienThoai, DiaChi, TrangThai, HinhPath
```

### 7.3. Các ph??ng th?c

| Ph??ng th?c | Mô t? |
|-------------|-------|
| GetAllForGrid() | L?y t?t c? khách hàng cho grid |
| SearchForGrid(kw) | Tìm theo MaKH, TenKH, SoDienThoai |
| GetById(id) | L?y khách hàng theo mã |
| Add(e) | Thêm khách hàng m?i |
| Update(e) | C?p nh?t thông tin |
| Delete(id) | Xóa khách hàng |

### 7.4. Thu?t toán Delete() ??c bi?t
```
Thu?t toán:
???????????????????????????????????????????
? 1. Tìm khách hàng                        ?
???????????????????????????????????????????
? 2. Ki?m tra ràng bu?c                   ?
?    hasKG = có ký g?i liên quan?         ?
?    hasHD = có hóa ??n liên quan?        ?
???????????????????????????????????????????
? 3. X? lý theo quy?n                     ?
?    ADMIN:                               ?
?      - Xóa t?t c? KyGuiRuou liên quan   ?
?      - Set null HoaDon.MaKH             ?
?      - Xóa KhachHang                    ?
?    KHÔNG PH?I ADMIN:                    ?
?      N?u có ràng bu?c ? Soft Delete     ?
?        TrangThai = "Ng?ng ho?t ??ng"    ?
?      N?u không ? Hard Delete            ?
???????????????????????????????????????????
```

---

## 8. DOUONGDAL - QU?N LÝ ?? U?NG

### 8.1. M?c ?ích
Qu?n lý b?ng DoUong (s?n ph?m).

### 8.2. Class l?ng DoUongGridRow
```
Properties:
  - MaDoUong, TenDoUong, DonGia, SoLuongTon
  - DonViTinh, DungTich, HanSuDung
  - GhiChu, TrangThai, HinhPath
  - TenLoai, MaLoai (t? LoaiDoUong liên k?t)
```

### 8.3. Thu?t toán Add()
```
1. Validate: MaDoUong, TenDoUong không r?ng
2. N?u MaLoai r?ng ? l?y lo?i ??u tiên ho?c "LOAI01"
3. N?u DonViTinh r?ng ? "Chai"
4. N?u TrangThai r?ng ? "Còn hàng"
5. db.DoUongs.Add(e)
6. SaveChanges()
```

### 8.4. Thu?t toán Delete()
```
T??ng t? KhachHangDal:
- ADMIN: Xóa c?ng + xóa ChiTietHoaDon liên quan
- Không ph?i ADMIN: Soft Delete n?u có ràng bu?c
```

---

## 9. LOAIDOUONGDAL - QU?N LÝ LO?I ?? U?NG

### 9.1. M?c ?ích
Qu?n lý danh m?c lo?i ?? u?ng.

### 9.2. Các ph??ng th?c
```
GetAll(): L?y t?t c?, s?p x?p theo TenLoai
GetById(id): L?y theo MaLoai
```

---

## 10. KYGUIRUOUDAL - QU?N LÝ KÝ G?I R??U

### 10.1. M?c ?ích
Qu?n lý nghi?p v? ký g?i r??u c?a khách hàng.

### 10.2. Class l?ng KyGuiGridRow
```
Properties:
  - MaKyGui, MaKH, TenKH (t? KhachHang)
  - TenRuou, DungTichConLai, DonViTinh
  - NgayKyGui, HanKyGui, ViTriLuuTru
  - TrangThai, HinhPath
```

### 10.3. Thu?t toán GenerateMaKyGui()
```
Output: "KG" + DateTime.Now.ToString("yyyyMMddHHmmss")
Ví d?: "KG20251228143522"
```

---

## 11. HOADONDAL - QU?N LÝ HÓA ??N

### 11.1. M?c ?ích
Qu?n lý và truy xu?t hóa ??n bán hàng.

### 11.2. Các class l?ng

#### HoaDonGridRow (hi?n th? danh sách)
```
MaHD, NgayHoaDon, MaKH, TenKH, MaNV, TenNV, TongTien, GhiChu
```

#### HoaDonPrintDto (in hóa ??n)
```
MaHD, NgayHoaDon, TenKH, SdtKH, DiaChiKH, TenNV
TongTien, GhiChu, Items (danh sách chi ti?t)
```

#### ItemDto (chi ti?t hóa ??n)
```
STT, MaDoUong, TenDoUong, DonGia, SoLuong, ThanhTien
```

### 11.3. Các ph??ng th?c

| Ph??ng th?c | Mô t? |
|-------------|-------|
| GetAll() | L?y t?t c? hóa ??n, s?p x?p m?i nh?t tr??c |
| GetByDateRange(from, to) | L?y hóa ??n trong kho?ng ngày |
| Search(keyword, from, to) | Tìm theo MaHD, TenKH, TenNV và l?c ngày |
| GetForPrint(maHd) | L?y chi ti?t hóa ??n ?? in |

### 11.4. Thu?t toán GetForPrint()
```
1. Tìm HoaDon theo maHd (Include KhachHang, NhanVien, ChiTietHoaDons)
2. L?y danh sách MaDoUong t? chi ti?t
3. Truy v?n tên ?? u?ng t?o Dictionary<MaDoUong, TenDoUong>
4. Map sang HoaDonPrintDto v?i Items
5. Tính STT t? t?ng cho t?ng item
```

---

## 12. BANHANGDAL - X? LÝ BÁN HÀNG

### 12.1. M?c ?ích
X? lý nghi?p v? thanh toán ??n hàng.

### 12.2. Class l?ng GioHangItem
```
MaDoUong: Mã s?n ph?m
DonGia: ??n giá (decimal)
SoLuong: S? l??ng (int)
```

### 12.3. Thu?t toán ThanhToan() - QUAN TR?NG NH?T

```
Input: maHd, ngay, maKh, maNv, ghiChu, List<GioHangItem> items

???????????????????????????????????????????????????????????????
? B??C 1: VALIDATE INPUT                                      ?
???????????????????????????????????????????????????????????????
? - Ki?m tra maHd không r?ng                                  ?
? - Ki?m tra items không null và không r?ng                  ?
? - V?i m?i item:                                             ?
?   + MaDoUong không r?ng                                     ?
?   + SoLuong > 0                                             ?
?   + DonGia >= 0                                             ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
? B??C 2: B?T ??U TRANSACTION                                 ?
???????????????????????????????????????????????????????????????
? db = DbConfig.Create()                                      ?
? tx = db.Database.BeginTransaction()                         ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
? B??C 3: KI?M TRA MÃ HÓA ??N                                 ?
???????????????????????????????????????????????????????????????
? N?u MaHD ?ã t?n t?i ? throw l?i                             ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
? B??C 4: L?Y DANH SÁCH ?? U?NG                               ?
???????????????????????????????????????????????????????????????
? maList = items.Select(x => x.MaDoUong).Distinct()          ?
? doUongs = db.DoUongs.Where(Contains maList)                ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
? B??C 5: VALIDATE T?N KHO                                    ?
???????????????????????????????????????????????????????????????
? V?i m?i item trong gi? hàng:                                ?
?   - Tìm ?? u?ng t??ng ?ng                                   ?
?   - N?u không tìm th?y ? throw l?i                         ?
?   - N?u SoLuongTon < SoLuong ? throw "T?n kho không ??"    ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
? B??C 6: TÍNH T?NG TI?N                                      ?
???????????????????????????????????????????????????????????????
? tongTien = SUM(DonGia * SoLuong)                            ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
? B??C 7: T?O HÓA ??N                                         ?
???????????????????????????????????????????????????????????????
? hoaDon = new HoaDon { MaHD, NgayHoaDon, MaKH, MaNV,        ?
?                       GhiChu, TongTien }                    ?
? db.HoaDons.Add(hoaDon)                                      ?
? db.SaveChanges()                                            ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
? B??C 8: THÊM CHI TI?T VÀ TR? T?N KHO                        ?
???????????????????????????????????????????????????????????????
? V?i m?i item:                                               ?
?   - Thêm ChiTietHoaDon (MaHD, MaDoUong, DonGia, SoLuong)   ?
?   - Tr? t?n kho: doUong.SoLuongTon -= item.SoLuong         ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
? B??C 9: COMMIT HO?C ROLLBACK                                ?
???????????????????????????????????????????????????????????????
? TRY:                                                        ?
?   db.SaveChanges()                                          ?
?   tx.Commit()                                               ?
? CATCH:                                                      ?
?   tx.Rollback()                                             ?
?   throw exception                                           ?
? FINALLY:                                                    ?
?   tx.Dispose()                                              ?
?   db.Dispose()                                              ?
???????????????????????????????????????????????????????????????
```

### 12.4. Ý ngh?a Transaction
- ??m b?o **tính toàn v?n d? li?u**
- N?u b?t k? b??c nào l?i ? **Rollback** t?t c?
- Tránh tình tr?ng:
  + T?o hóa ??n nh?ng không có chi ti?t
  + Tr? t?n kho nh?ng không l?u hóa ??n

---

## 13. REPORTDAL - BÁO CÁO TH?NG KÊ

### 13.1. M?c ?ích
Cung c?p d? li?u cho các báo cáo.

### 13.2. Class l?ng DoanhThuRow
```
Ngay: Ngày bán hàng
SoHoaDon: S? l??ng hóa ??n trong ngày
TongTien: T?ng doanh thu ngày
```

### 13.3. Thu?t toán GetDoanhThuByDateRange()
```
1. Chuy?n from v? ??u ngày, to v? cu?i ngày +1
2. Query HoaDons trong kho?ng th?i gian
3. GroupBy theo ngày (TruncateTime)
4. Select: Ngay, Count(), Sum(TongTien)
5. OrderBy Ngay t?ng d?n
```

### 13.4. GetTonKho() và SearchTonKho()
```
Truy v?n view vw_TonKho trong database
Cung c?p d? li?u: MaDoUong, TenDoUong, DonGia, SoLuongTon
```

---

## 14. VITRILUUTRUDAL - QU?N LÝ V? TRÍ L?U TR?

### 14.1. M?c ?ích
Qu?n lý v? trí l?u tr? r??u ký g?i.

### 14.2. Class l?ng ViTriGridRow
```
MaViTri, TenViTri, MoTa, TrangThai
```

### 14.3. ??c bi?t: Try-Catch cho b?ng có th? không t?n t?i
```csharp
try
{
    return DbConfig.Use(db => db.ViTriLuuTrus...);
}
catch
{
    // N?u b?ng ch?a t?n t?i ? tr? v? list r?ng
    return new List<ViTriGridRow>();
}
```

### 14.4. Thu?t toán Delete() v?i Soft Delete
```
1. Tìm v? trí theo id
2. Ki?m tra có ký g?i nào ?ang s? d?ng không
3. N?u CÓ:
   - Chuy?n TrangThai = "Ng?ng ho?t ??ng"
   - Throw thông báo cho ng??i dùng bi?t
4. N?u KHÔNG:
   - Remove v? trí
   - SaveChanges()
```

---

## TÓM T?T CÁC PATTERN S? D?NG

### Pattern 1: Using Pattern v?i DbConfig.Use()
```csharp
// Thay vì:
using (var db = new Model1())
{
    return db.NhanViens.ToList();
}

// S? d?ng:
return DbConfig.Use(db => db.NhanViens.ToList());
```

### Pattern 2: GridRow Class
```
M?i DAL có nested class ??:
- Ch?a d? li?u hi?n th? lên grid
- Join d? li?u t? nhi?u b?ng
- ?n các c?t không c?n thi?t
```

### Pattern 3: Soft Delete vs Hard Delete
```
SOFT DELETE: Chuy?n TrangThai thay vì xóa
- Dùng khi có d? li?u liên quan
- Gi? l?i l?ch s?

HARD DELETE: Xóa th?c s?
- Dùng khi không có ràng bu?c
- Ch? Admin m?i ???c phép
```

### Pattern 4: Transaction cho thao tác ph?c t?p
```
- Thêm NhanVien + TaiKhoan
- Thanh toán hóa ??n
- Xóa có cascade
```

---

## K?T LU?N

T?ng DAL trong d? án Qu?n Lý C?a Hàng R??u ???c thi?t k? v?i:

1. **Tính tách bi?t**: GUI không truy c?p tr?c ti?p database
2. **Tính tái s? d?ng**: DbConfig.Use() dùng chung cho t?t c?
3. **Tính b?o m?t**: Ki?m tra quy?n trong các thao tác nh?y c?m
4. **Tính toàn v?n**: Transaction ??m b?o d? li?u nh?t quán
5. **Tính m? r?ng**: D? dàng thêm DAL m?i theo cùng pattern

---

*Tài li?u ???c t?o t? ??ng - D? án HUTECH*
*Ngày t?o: 28/12/2025*
